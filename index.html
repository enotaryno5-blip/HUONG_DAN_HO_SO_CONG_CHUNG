<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng ch·ª©ng t√†i s·∫£n - H·ªá th·ªëng h∆∞·ªõng d·∫´n h·ªì s∆°</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .progress-container {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b09b, #96c93d);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .step {
            text-align: center;
            flex: 1;
        }

        .step.active {
            color: #00b09b;
            font-weight: bold;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .form-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section.active {
            display: block;
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
            font-size: 1.8em;
        }

        .question-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .question {
            margin-bottom: 20px;
        }

        .question label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .question.required label::after {
            content: " *";
            color: #e74c3c;
        }

        .question input, .question select, .question textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .question input:focus, .question select:focus, .question textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .owner-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .owner-card:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .owner-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .owner-card h3::before {
            content: "üë§";
            margin-right: 10px;
        }

        .dynamic-content {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .dynamic-content.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-prev {
            background: #6c757d;
            color: white;
        }

        .btn-prev:hover {
            background: #5a6268;
        }

        .btn-next {
            background: #3498db;
            color: white;
        }

        .btn-next:hover {
            background: #2980b9;
        }

        .btn-guidance {
            background: #00b09b;
            color: white;
        }

        .btn-guidance:hover {
            background: #009c7b;
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
        }

        .btn-reset:hover {
            background: #c0392b;
        }

        .guidance-phase {
            display: none;
        }

        .guidance-result {
            background: white;
            border-radius: 10px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .guidance-header {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            padding: 20px;
        }

        .guidance-content {
            padding: 25px;
        }

        .guidance-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .guidance-item.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .guidance-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .guidance-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .guidance-item.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input-group input {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-item input[type="radio"] {
            width: auto;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            color: #3498db;
            cursor: help;
        }

        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background: #2c3e50;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .sub-question {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid #3498db;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .date-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>H·ªÜ TH·ªêNG H∆Ø·ªöNG D·∫™N C√îNG CH·ª®NG T√ÄI S·∫¢N</h1>
            <div class="subtitle">K·ªãch b·∫£n x·ª≠ l√Ω v√† h∆∞·ªõng d·∫´n h·ªì s∆° to√†n di·ªán</div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-steps">
                <div class="step active" id="step-A1">Gi·∫•y ch·ª©ng nh·∫≠n</div>
                <div class="step" id="step-A2">T√¨nh tr·∫°ng h√¥n nh√¢n</div>
                <div class="step" id="step-A3">NƒÉng l·ª±c h√†nh vi</div>
                <div class="step" id="step-A4">T·ªï ch·ª©c</div>
                <div class="step" id="step-A5">·ª¶y quy·ªÅn</div>
                <div class="step" id="step-B">K·∫øt qu·∫£</div>
            </div>
        </div>

        <!-- PH·∫¶N A: H·ªéI TH√îNG TIN -->
        <div class="content" id="question-phase">
            
            <!-- SECTION A1: GI·∫§Y CH·ª®NG NH·∫¨N -->
            <div id="section-A1" class="form-section active">
                <h2 class="section-title">A1. TH√îNG TIN GI·∫§Y CH·ª®NG NH·∫¨N</h2>
                
                <div class="question-group">
                    <div class="question required">
                        <label>ƒê√£ c√≥ Gi·∫•y ch·ª©ng nh·∫≠n QSDƒê/QSHN/T√†i s·∫£n ch∆∞a?</label>
                        <select id="hasCertificate" onchange="handleHasCertificate()">
                            <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                            <option value="CHUA">CH∆ØA c√≥ GCN</option>
                            <option value="CO">ƒê√£ C√ì GCN</option>
                        </select>
                    </div>

                    <div id="certificate-details" class="dynamic-content">
                        <div class="question required">
                            <label>S·ªë l∆∞·ª£ng ch·ªß th·ªÉ tr√™n Gi·∫•y ch·ª©ng nh·∫≠n:</label>
                            <input type="number" id="ownerCount" min="1" max="20" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng ch·ªß s·ªü h·ªØu" onchange="handleOwnerCount()">
                        </div>

                        <div id="owner-forms"></div>

                        <div class="question required">
                            <label>Ngu·ªìn g·ªëc s·ªü h·ªØu t√†i s·∫£n:</label>
                            <select id="ownershipSource" onchange="handleOwnershipSource()">
                                <option value="">-- Ch·ªçn ngu·ªìn g·ªëc --</option>
                                <option value="MUA_TANG_THUA_KHE_GOP_VON">Mua/ƒë∆∞·ª£c t·∫∑ng cho/th·ª´a k·∫ø/nh·∫≠n g√≥p v·ªën/ƒë∆∞·ª£c giao ƒë·∫•t/thu√™ ƒë·∫•t</option>
                                <option value="CONG_NHAN_QSDD">ƒê∆∞·ª£c nh√† n∆∞·ªõc c√¥ng nh·∫≠n QSDƒê</option>
                            </select>
                        </div>

                        <div id="ownership-date-container" class="dynamic-content">
                            <div class="question required">
                                <label id="ownershipDateLabel">Ng√†y s·ªü h·ªØu t√†i s·∫£n:</label>
                                <input type="date" id="ownershipDate" onchange="updateState('ownershipDate', this.value)">
                                <small class="tooltip">‚ÑπÔ∏è
                                    <span class="tooltip-text" id="ownershipDateTooltip"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-prev" onclick="previousSection()" disabled>‚¨Ö Quay l·∫°i</button>
                    <button class="btn btn-next" onclick="nextSection()">Ti·∫øp theo ‚û°</button>
                </div>
            </div>

            <!-- SECTION A2: T√åNH TR·∫†NG H√îN NH√ÇN -->
            <div id="section-A2" class="form-section">
                <h2 class="section-title">A2. T√åNH TR·∫†NG H√îN NH√ÇN C·ª¶A CH·ª¶ S·ªû H·ªÆU</h2>
                <div id="marital-status-forms"></div>
                <div class="navigation">
                    <button class="btn btn-prev" onclick="previousSection()">‚¨Ö Quay l·∫°i</button>
                    <button class="btn btn-next" onclick="nextSection()">Ti·∫øp theo ‚û°</button>
                </div>
            </div>

            <!-- SECTION A3: NƒÇNG L·ª∞C H√ÄNH VI -->
            <div id="section-A3" class="form-section">
                <h2 class="section-title">A3. NƒÇNG L·ª∞C H√ÄNH VI V√Ä GI√ÅM H·ªò</h2>
                <div id="civil-capacity-forms"></div>
                <div class="navigation">
                    <button class="btn btn-prev" onclick="previousSection()">‚¨Ö Quay l·∫°i</button>
                    <button class="btn btn-next" onclick="nextSection()">Ti·∫øp theo ‚û°</button>
                </div>
            </div>

            <!-- SECTION A4: TH√îNG TIN T·ªî CH·ª®C -->
            <div id="section-A4" class="form-section">
                <h2 class="section-title">A4. TH√îNG TIN T·ªî CH·ª®C/DOANH NGHI·ªÜP</h2>
                <div id="organization-forms"></div>
                <div class="navigation">
                    <button class="btn btn-prev" onclick="previousSection()">‚¨Ö Quay l·∫°i</button>
                    <button class="btn btn-next" onclick="nextSection()">Ti·∫øp theo ‚û°</button>
                </div>
            </div>

            <!-- SECTION A5: ·ª¶Y QUY·ªÄN -->
            <div id="section-A5" class="form-section">
                <h2 class="section-title">A5. TH√îNG TIN ·ª¶Y QUY·ªÄN</h2>
                <div id="power-of-attorney-forms"></div>
                <div class="navigation">
                    <button class="btn btn-prev" onclick="previousSection()">‚¨Ö Quay l·∫°i</button>
                    <button class="btn btn-guidance" onclick="generateGuidance()">Xem h∆∞·ªõng d·∫´n ‚û°</button>
                </div>
            </div>
        </div>

        <!-- PH·∫¶N B: H∆Ø·ªöNG D·∫™N H·ªí S∆† -->
        <div class="content guidance-phase" id="guidance-phase">
            <div class="guidance-result">
                <div class="guidance-header">
                    <h2>K·∫æT QU·∫¢ H∆Ø·ªöNG D·∫™N H·ªí S∆†</h2>
                    <p>D·ª±a tr√™n th√¥ng tin b·∫°n ƒë√£ cung c·∫•p</p>
                </div>
                <div class="guidance-content">
                    <div id="guidance-results"></div>
                </div>
            </div>
            <div class="navigation">
                <button class="btn btn-prev" onclick="showQuestionPhase()">‚¨Ö Quay l·∫°i s·ª≠a th√¥ng tin</button>
                <button class="btn btn-reset" onclick="resetApp()">üîÑ L√†m l·∫°i t·ª´ ƒë·∫ßu</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================
        // STATE MANAGEMENT
        // ===============================
        const appState = {
            currentSection: 'A1',
            sections: ['A1', 'A2', 'A3', 'A4', 'A5'],
            answers: {
                hasCertificate: null,
                ownerCount: 0,
                owners: [],
                ownershipSource: null,
                ownershipDate: null,
                maritalStatus: {},
                civilCapacity: {
                    transactionType: null,
                    ownersLostCapacity: [],
                    spousesLostCapacity: [],
                    ownerDocuments: {},
                    spouseDocuments: {}
                },
                organizationInfo: {},
                powerOfAttorney: {
                    owners: [],
                    spouses: [],
                    ownerInfo: {},
                    spouseInfo: {}
                }
            },
            guidance: []
        };

        // ===============================
        // UTILITY FUNCTIONS
        // ===============================
        function updateState(key, value, subKey = null, subSubKey = null) {
            if (subSubKey) {
                appState.answers[key][subKey][subSubKey] = value;
            } else if (subKey) {
                appState.answers[key][subKey] = value;
            } else {
                appState.answers[key] = value;
            }
            updateProgress();
        }

        function updateProgress() {
            const totalSteps = 6;
            let completedSteps = 1; // A1 is always started

            // Check which sections are completed
            if (appState.answers.hasCertificate === 'CO' && appState.answers.ownerCount > 0) completedSteps++;
            if (Object.keys(appState.answers.maritalStatus).length > 0) completedSteps++;
            if (appState.answers.civilCapacity.transactionType) completedSteps++;
            if (Object.keys(appState.answers.organizationInfo).length > 0) completedSteps++;
            if (appState.answers.powerOfAttorney.owners.length > 0 || appState.answers.powerOfAttorney.spouses.length > 0) completedSteps++;

            const progress = (completedSteps / totalSteps) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;

            // Update step indicators
            appState.sections.forEach((section, index) => {
                const stepElement = document.getElementById(`step-${section}`);
                if (index < completedSteps - 1) {
                    stepElement.classList.add('active');
                } else {
                    stepElement.classList.remove('active');
                }
            });
        }

        function showSection(sectionId) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section-${sectionId}`).classList.add('active');
            appState.currentSection = sectionId;
            updateProgress();
        }

        function nextSection() {
            const currentIndex = appState.sections.indexOf(appState.currentSection);
            if (currentIndex < appState.sections.length - 1) {
                showSection(appState.sections[currentIndex + 1]);
                // Render dynamic content for next section
                if (appState.sections[currentIndex + 1] === 'A2') {
                    renderMaritalStatusForms();
                } else if (appState.sections[currentIndex + 1] === 'A3') {
                    renderCivilCapacityForms();
                } else if (appState.sections[currentIndex + 1] === 'A4') {
                    renderOrganizationForms();
                } else if (appState.sections[currentIndex + 1] === 'A5') {
                    renderPowerOfAttorneyForms();
                }
            }
        }

        function previousSection() {
            const currentIndex = appState.sections.indexOf(appState.currentSection);
            if (currentIndex > 0) {
                showSection(appState.sections[currentIndex - 1]);
            }
        }

        // ===============================
        // SECTION A1: GI·∫§Y CH·ª®NG NH·∫¨N
        // ===============================
        function handleHasCertificate() {
            const hasCert = document.getElementById('hasCertificate').value;
            updateState('hasCertificate', hasCert);
            
            const certDetails = document.getElementById('certificate-details');
            if (hasCert === 'CHUA') {
                certDetails.classList.remove('active');
            } else if (hasCert === 'CO') {
                certDetails.classList.add('active');
            }
        }

        function handleOwnerCount() {
            const count = parseInt(document.getElementById('ownerCount').value);
            if (isNaN(count) || count < 1) return;
            
            updateState('ownerCount', count);
            
            const ownerForms = document.getElementById('owner-forms');
            ownerForms.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                ownerForms.innerHTML += `
                    <div class="owner-card">
                        <h3>Ch·ªß s·ªü h·ªØu ${i + 1}</h3>
                        <div class="question required">
                            <label>Lo·∫°i ch·ªß s·ªü h·ªØu:</label>
                            <select onchange="handleOwnerType(${i}, this.value)">
                                <option value="">-- Ch·ªçn lo·∫°i --</option>
                                <option value="CA_NHAN">C√° nh√¢n</option>
                                <option value="TO_CHUC">T·ªï ch·ª©c/Doanh nghi·ªáp</option>
                            </select>
                        </div>
                        <div id="owner-details-${i}"></div>
                    </div>
                `;
                
                // Initialize owner object
                if (!appState.answers.owners[i]) {
                    appState.answers.owners[i] = { type: null };
                }
            }
        }

        function handleOwnerType(index, type) {
            appState.answers.owners[index].type = type;
            const detailsDiv = document.getElementById(`owner-details-${index}`);
            
            if (type === 'CA_NHAN') {
                detailsDiv.innerHTML = `
                    <div class="question required">
                        <label>H·ªç v√† t√™n:</label>
                        <input type="text" placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß" onchange="updateOwnerField(${index}, 'name', this.value)">
                    </div>
                    <div class="question required">
                        <label>S·ªë CMND/CCCD:</label>
                        <input type="text" placeholder="9 s·ªë (CMND) ho·∫∑c 12 s·ªë (CCCD)" onchange="updateOwnerField(${index}, 'idNumber', this.value)">
                    </div>
                    <div class="question required">
                        <label>Ng√†y th√°ng nƒÉm sinh:</label>
                        <input type="date" onchange="updateOwnerField(${index}, 'birthDate', this.value)">
                    </div>
                `;
            } else if (type === 'TO_CHUC') {
                detailsDiv.innerHTML = `
                    <div class="question required">
                        <label>T√™n t·ªï ch·ª©c (ti·∫øng Vi·ªát):</label>
                        <input type="text" placeholder="T√™n ƒë·∫ßy ƒë·ªß b·∫±ng ti·∫øng Vi·ªát" onchange="updateOwnerField(${index}, 'orgName', this.value)">
                    </div>
                    <div class="question">
                        <label>M√£ s·ªë doanh nghi·ªáp/MST/S·ªë ƒêKKD:</label>
                        <input type="text" placeholder="Nh·∫≠p m√£ s·ªë (n·∫øu c√≥)" onchange="updateOwnerField(${index}, 'businessCode', this.value)">
                    </div>
                `;
            }
        }

        function updateOwnerField(index, field, value) {
            if (!appState.answers.owners[index]) {
                appState.answers.owners[index] = {};
            }
            appState.answers.owners[index][field] = value;
        }

        function handleOwnershipSource() {
            const source = document.getElementById('ownershipSource').value;
            updateState('ownershipSource', source);
            
            const dateContainer = document.getElementById('ownership-date-container');
            const tooltip = document.getElementById('ownershipDateTooltip');
            
            if (source) {
                dateContainer.classList.add('active');
                
                if (source === 'MUA_TANG_THUA_KHE_GOP_VON') {
                    document.getElementById('ownershipDateLabel').textContent = 'Ng√†y s·ªü h·ªØu (ng√†y ƒëƒÉng k√Ω thay ƒë·ªïi ch·ªß/ng√†y c·∫•p GCN):';
                    tooltip.textContent = 'L·∫•y ng√†y ƒëƒÉng k√Ω thay ƒë·ªïi ch·ªß; n·∫øu kh√¥ng c√≥ ng√†y ƒëƒÉng k√Ω thay ƒë·ªïi th√¨ l·∫•y ng√†y c·∫•p GCN';
                } else if (source === 'CONG_NHAN_QSDD') {
                    document.getElementById('ownershipDateLabel').textContent = 'Ng√†y s·ªü h·ªØu (ng√†y th·ª±c t·∫ø t·∫°o d·ª±ng t√†i s·∫£n):';
                    tooltip.textContent = 'Kh√¥ng l·∫•y ng√†y c·∫•p GCN, cung c·∫•p ng√†y TH·ª∞C T·∫æ t·∫°o d·ª±ng t√†i s·∫£n';
                }
            } else {
                dateContainer.classList.remove('active');
            }
        }

        // ===============================
        // SECTION A2: T√åNH TR·∫†NG H√îN NH√ÇN
        // ===============================
        function renderMaritalStatusForms() {
            const container = document.getElementById('marital-status-forms');
            container.innerHTML = '';
            
            let hasIndividualOwner = false;
            
            appState.answers.owners.forEach((owner, index) => {
                if (owner.type === 'CA_NHAN') {
                    hasIndividualOwner = true;
                    container.innerHTML += `
                        <div class="owner-card">
                            <h3>T√¨nh tr·∫°ng h√¥n nh√¢n - ${owner.name || `Ch·ªß s·ªü h·ªØu ${index + 1}`}</h3>
                            <div class="question required">
                                <label>T√¨nh tr·∫°ng h√¥n nh√¢n hi·ªán t·∫°i:</label>
                                <select onchange="handleMaritalStatus(${index}, this.value)">
                                    <option value="">-- Ch·ªçn t√¨nh tr·∫°ng --</option>
                                    <option value="CHUA_TUNG_KET_HON">CH∆ØA T·ª™NG K·∫æT H√îN</option>
                                    <option value="DANG_CO_VO_CHONG_LAN_DAU">ƒêANG C√ì V·ª¢/CH·ªíNG (k·∫øt h√¥n l·∫ßn ƒë·∫ßu)</option>
                                    <option value="DANG_CO_VO_CHONG_TAI_HON">ƒêANG C√ì V·ª¢/CH·ªíNG (t√°i h√¥n)</option>
                                    <option value="DOC_THAN_DA_LY_HON">ƒê·ªòC TH√ÇN, ƒê√É LY H√îN</option>
                                    <option value="DOC_THAN_VO_CHONG_CHET">ƒê·ªòC TH√ÇN, V·ª¢/CH·ªíNG ƒê√É CH·∫æT</option>
                                </select>
                            </div>
                            <div id="marital-details-${index}"></div>
                        </div>
                    `;
                    
                    // Initialize marital status object
                    if (!appState.answers.maritalStatus[index]) {
                        appState.answers.maritalStatus[index] = { status: null };
                    }
                }
            });
            
            if (!hasIndividualOwner) {
                container.innerHTML = '<p>Kh√¥ng c√≥ ch·ªß s·ªü h·ªØu c√° nh√¢n n√†o trong danh s√°ch.</p>';
            }
        }

        function handleMaritalStatus(ownerIndex, status) {
            if (!appState.answers.maritalStatus[ownerIndex]) {
                appState.answers.maritalStatus[ownerIndex] = {};
            }
            appState.answers.maritalStatus[ownerIndex].status = status;
            
            const detailsDiv = document.getElementById(`marital-details-${ownerIndex}`);
            detailsDiv.innerHTML = '';
            
            switch(status) {
                case 'CHUA_TUNG_KET_HON':
                    renderChuaTungKetHon(ownerIndex, detailsDiv);
                    break;
                case 'DANG_CO_VO_CHONG_LAN_DAU':
                    renderDangCoVoChongLanDau(ownerIndex, detailsDiv);
                    break;
                case 'DANG_CO_VO_CHONG_TAI_HON':
                    renderDangCoVoChongTaiHon(ownerIndex, detailsDiv);
                    break;
                case 'DOC_THAN_DA_LY_HON':
                    renderDocThanDaLyHon(ownerIndex, detailsDiv);
                    break;
                case 'DOC_THAN_VO_CHONG_CHET':
                    renderDocThanVoChongChet(ownerIndex, detailsDiv);
                    break;
            }
        }

        function renderChuaTungKetHon(ownerIndex, container) {
            container.innerHTML = `
                <div class="question">
                    <label>ƒê√£ c√≥ gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n ch∆∞a?</label>
                    <select onchange="handleChuaTungKetHonDocs(${ownerIndex}, this.value)">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="CHUA">Ch∆∞a c√≥</option>
                        <option value="DA_CO">ƒê√£ c√≥</option>
                    </select>
                </div>
                <div id="chua-tung-ket-hon-details-${ownerIndex}"></div>
            `;
        }

        function handleChuaTungKetHonDocs(ownerIndex, hasDoc) {
            const detailsDiv = document.getElementById(`chua-tung-ket-hon-details-${ownerIndex}`);
            
            if (hasDoc === 'DA_CO') {
                detailsDiv.innerHTML = `
                    <div class="question required">
                        <label>N·ªôi dung ghi trong gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n:</label>
                        <select onchange="updateMaritalField(${ownerIndex}, 'xntthnContent', this.value)">
                            <option value="">-- Ch·ªçn n·ªôi dung --</option>
                            <option value="CHI_HIEN_TAI">Ch·ªâ c√≥ n·ªôi dung "hi·ªán t·∫°i ch∆∞a k·∫øt h√¥n v·ªõi ai"</option>
                            <option value="VUA_CO_KHOANG_THOI_GIAN">V·ª´a c√≥ n·ªôi dung "t·ª´ ng√†y ..... ƒë·∫øn... ch∆∞a k·∫øt h√¥n v·ªõi ai" v√† "hi·ªán t·∫°i ch∆∞a k·∫øt h√¥n v·ªõi ai"</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Ng√†y c·∫•p gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n:</label>
                        <input type="date" onchange="updateMaritalField(${ownerIndex}, 'xntthnDate', this.value)">
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = '';
            }
            updateMaritalField(ownerIndex, 'hasXNTTHN', hasDoc);
        }

        function renderDangCoVoChongLanDau(ownerIndex, container) {
            container.innerHTML = `
                <div class="question">
                    <label>Gi·∫•y t·ªù hi·ªán c√≥:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="gcnkh-${ownerIndex}" onchange="handleDangCoVoChongDocs(${ownerIndex})">
                            <label for="gcnkh-${ownerIndex}">C√≥ Gi·∫•y ch·ª©ng nh·∫≠n k·∫øt h√¥n</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="xntthn-${ownerIndex}" onchange="handleDangCoVoChongDocs(${ownerIndex})">
                            <label for="xntthn-${ownerIndex}">C√≥ gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="chua-co-${ownerIndex}" onchange="handleDangCoVoChongDocs(${ownerIndex})">
                            <label for="chua-co-${ownerIndex}">Ch∆∞a c√≥ gi·∫•y t·ªù</label>
                        </div>
                    </div>
                </div>
                <div id="dang-co-vo-chong-details-${ownerIndex}"></div>
            `;
        }

        function handleDangCoVoChongDocs(ownerIndex) {
            const hasGCNKH = document.getElementById(`gcnkh-${ownerIndex}`).checked;
            const hasXNTTTHN = document.getElementById(`xntthn-${ownerIndex}`).checked;
            const hasNone = document.getElementById(`chua-co-${ownerIndex}`).checked;
            
            const detailsDiv = document.getElementById(`dang-co-vo-chong-details-${ownerIndex}`);
            let html = '';
            
            if (hasGCNKH) {
                html += `
                    <div class="dynamic-content active">
                        <h4>Th√¥ng tin Gi·∫•y ch·ª©ng nh·∫≠n k·∫øt h√¥n</h4>
                        <div class="question required">
                            <label>Ng√†y h√¥n nh√¢n c√≥ hi·ªáu l·ª±c:</label>
                            <select onchange="updateMaritalField(${ownerIndex}, 'effectiveDateType', this.value)">
                                <option value="">-- Ch·ªçn lo·∫°i ng√†y --</option>
                                <option value="NGAY_DANG_KY">Ng√†y ƒëƒÉng k√Ω k·∫øt h√¥n</option>
                                <option value="NGAY_CONG_NHAN">Ng√†y ƒë∆∞·ª£c c√¥ng nh·∫≠n ghi t·∫°i M·ª•c Ghi ch√∫ c·ªßa ƒêKKH</option>
                            </select>
                        </div>
                        <div class="question required">
                            <label>Ng√†y h√¥n nh√¢n c√≥ hi·ªáu l·ª±c:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'effectiveDate', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'spouseName', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh c·ªßa v·ª£/ch·ªìng:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'spouseId', this.value)">
                        </div>
                    </div>
                `;
            }
            
            if (hasXNTTTHN) {
                html += `
                    <div class="dynamic-content active">
                        <h4>Th√¥ng tin Gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n</h4>
                        <div class="question required">
                            <label>Ng√†y c·∫•p gi·∫•y x√°c nh·∫≠n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'xntthnDate2', this.value)">
                        </div>
                        <div class="question required">
                            <label>N·ªôi dung ghi trong gi·∫•y x√°c nh·∫≠n:</label>
                            <select onchange="updateMaritalField(${ownerIndex}, 'xntthnContent2', this.value)">
                                <option value="">-- Ch·ªçn n·ªôi dung --</option>
                                <option value="CHI_HIEN_TAI">Ch·ªâ c√≥ n·ªôi dung "hi·ªán t·∫°i ch∆∞a k·∫øt h√¥n v·ªõi ai"</option>
                                <option value="VUA_CO_KHOANG_THOI_GIAN">V·ª´a c√≥ n·ªôi dung kho·∫£ng th·ªùi gian v√† "hi·ªán t·∫°i ch∆∞a k·∫øt h√¥n v·ªõi ai"</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            detailsDiv.innerHTML = html;
            
            // Update state
            updateMaritalField(ownerIndex, 'hasGCNKH', hasGCNKH);
            updateMaritalField(ownerIndex, 'hasXNTTTHN', hasXNTTTHN);
            updateMaritalField(ownerIndex, 'hasNoDocs', hasNone);
        }

        function renderDangCoVoChongTaiHon(ownerIndex, container) {
            container.innerHTML = `
                <div class="question required">
                    <label>L√Ω do k·∫øt th√∫c cu·ªôc h√¥n nh√¢n tr∆∞·ªõc ƒë√¢y:</label>
                    <select onchange="handleLyDoKetThucHonNhan(${ownerIndex}, this.value)">
                        <option value="">-- Ch·ªçn l√Ω do --</option>
                        <option value="LY_HON">Ly h√¥n</option>
                        <option value="VO_CHONG_CU_CHET">V·ª£/ch·ªìng c≈© ch·∫øt</option>
                    </select>
                </div>
                <div id="ly-do-ket-thuc-details-${ownerIndex}"></div>
                <div class="question">
                    <label>Gi·∫•y t·ªù hi·ªán c√≥ v·ªÅ h√¥n nh√¢n:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="gcnkh-hientai-${ownerIndex}" onchange="handleTaiHonDocs(${ownerIndex})">
                            <label for="gcnkh-hientai-${ownerIndex}">C√≥ Gi·∫•y ch·ª©ng nh·∫≠n k·∫øt h√¥n (c·ªßa h√¥n nh√¢n hi·ªán t·∫°i)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="xntthn-truockethon-${ownerIndex}" onchange="handleTaiHonDocs(${ownerIndex})">
                            <label for="xntthn-truockethon-${ownerIndex}">C√≥ gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n (cho giai ƒëo·∫°n tr∆∞·ªõc k·∫øt h√¥n)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="chua-co-taihon-${ownerIndex}" onchange="handleTaiHonDocs(${ownerIndex})">
                            <label for="chua-co-taihon-${ownerIndex}">Ch∆∞a c√≥ gi·∫•y t·ªù</label>
                        </div>
                    </div>
                </div>
                <div id="tai-hon-details-${ownerIndex}"></div>
            `;
        }

        function handleLyDoKetThucHonNhan(ownerIndex, reason) {
            const detailsDiv = document.getElementById(`ly-do-ket-thuc-details-${ownerIndex}`);
            updateMaritalField(ownerIndex, 'previousMarriageEndReason', reason);
            
            if (reason === 'LY_HON') {
                detailsDiv.innerHTML = `
                    <div class="sub-question">
                        <div class="question required">
                            <label>Ng√†y ly h√¥n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'divorceDate', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseName', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseId', this.value)">
                        </div>
                    </div>
                `;
            } else if (reason === 'VO_CHONG_CU_CHET') {
                detailsDiv.innerHTML = `
                    <div class="sub-question">
                        <div class="question required">
                            <label>Ng√†y ch·∫øt c·ªßa v·ª£/ch·ªìng c≈©:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'exSpouseDeathDate', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseName', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseId', this.value)">
                        </div>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function handleTaiHonDocs(ownerIndex) {
            const hasGCNKH = document.getElementById(`gcnkh-hientai-${ownerIndex}`).checked;
            const hasXNTTTHN = document.getElementById(`xntthn-truockethon-${ownerIndex}`).checked;
            const hasNone = document.getElementById(`chua-co-taihon-${ownerIndex}`).checked;
            
            const detailsDiv = document.getElementById(`tai-hon-details-${ownerIndex}`);
            let html = '';
            
            if (hasGCNKH) {
                html += `
                    <div class="dynamic-content active">
                        <h4>Th√¥ng tin Gi·∫•y ch·ª©ng nh·∫≠n k·∫øt h√¥n hi·ªán t·∫°i</h4>
                        <div class="question required">
                            <label>Ng√†y h√¥n nh√¢n c√≥ hi·ªáu l·ª±c:</label>
                            <select onchange="updateMaritalField(${ownerIndex}, 'currentMarriageEffectiveDateType', this.value)">
                                <option value="">-- Ch·ªçn lo·∫°i ng√†y --</option>
                                <option value="NGAY_DANG_KY">Ng√†y ƒëƒÉng k√Ω k·∫øt h√¥n</option>
                                <option value="NGAY_CONG_NHAN">Ng√†y ƒë∆∞·ª£c c√¥ng nh·∫≠n ghi t·∫°i M·ª•c Ghi ch√∫ c·ªßa ƒêKKH</option>
                            </select>
                        </div>
                        <div class="question required">
                            <label>Ng√†y h√¥n nh√¢n c√≥ hi·ªáu l·ª±c:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'currentMarriageEffectiveDate', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng hi·ªán t·∫°i:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'currentSpouseName', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng hi·ªán t·∫°i:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'currentSpouseId', this.value)">
                        </div>
                    </div>
                `;
            }
            
            if (hasXNTTTHN) {
                html += `
                    <div class="dynamic-content active">
                        <h4>Th√¥ng tin Gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n tr∆∞·ªõc k·∫øt h√¥n</h4>
                        <div class="question required">
                            <label>Ng√†y c·∫•p gi·∫•y x√°c nh·∫≠n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'preMarriageXNTTHNDate', this.value)">
                        </div>
                        <div class="question required">
                            <label>"KHO·∫¢NG TH·ªúI GIAN ƒë∆∞·ª£c x√°c nh·∫≠n" c√≥ t√≠nh t·ª´ th·ªùi ƒëi·ªÉm Ly h√¥n/ch·∫øt c·ªßa v·ª£/ch·ªìng kh√¥ng?</label>
                            <select onchange="updateMaritalField(${ownerIndex}, 'preMarriageTimeFromEvent', this.value)">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="CO">C√≥</option>
                                <option value="KHONG">Kh√¥ng</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            // Special case: Only XNTTHN selected
            if (hasXNTTTHN && !hasGCNKH && !hasNone) {
                html += `
                    <div class="dynamic-content active">
                        <h4>Th√¥ng tin b·ªï sung (ch·ªâ c√≥ XNTTHN)</h4>
                        <div class="question required">
                            <label>Ng√†y h√¥n nh√¢n c√≥ hi·ªáu l·ª±c:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'marriageEffectiveDateXNTTHNOnly', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'spouseNameXNTTHNOnly', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'spouseIdXNTTHNOnly', this.value)">
                        </div>
                    </div>
                `;
            }
            
            detailsDiv.innerHTML = html;
            
            // Update state
            updateMaritalField(ownerIndex, 'hasCurrentGCNKH', hasGCNKH);
            updateMaritalField(ownerIndex, 'hasPreMarriageXNTTTHN', hasXNTTTHN);
            updateMaritalField(ownerIndex, 'hasNoDocsTaiHon', hasNone);
        }

        function renderDocThanDaLyHon(ownerIndex, container) {
            container.innerHTML = `
                <div class="question">
                    <label>ƒê√£ c√≥ gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n ch∆∞a?</label>
                    <select onchange="handleDocThanDaLyHonDocs(${ownerIndex}, this.value)">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="CHUA_CO">Ch∆∞a c√≥</option>
                        <option value="DA_CO">ƒê√£ c√≥</option>
                    </select>
                </div>
                <div id="doc-than-ly-hon-details-${ownerIndex}"></div>
                <div class="question required">
                    <label>T√†i s·∫£n ƒëang y√™u c·∫ßu c√¥ng ch·ª©ng c√≥ ph·∫£i t√†i s·∫£n chung v·ªõi v·ª£ ch·ªìng c≈© kh√¥ng?</label>
                    <select onchange="updateMaritalField(${ownerIndex}, 'isPropertyWithExSpouse', this.value)">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="CO">C√≥</option>
                        <option value="KHONG">Kh√¥ng</option>
                    </select>
                </div>
            `;
        }

        function handleDocThanDaLyHonDocs(ownerIndex, hasDoc) {
            const detailsDiv = document.getElementById(`doc-than-ly-hon-details-${ownerIndex}`);
            updateMaritalField(ownerIndex, 'hasXNTTHN_LyHon', hasDoc);
            
            if (hasDoc === 'CHUA_CO') {
                detailsDiv.innerHTML = `
                    <div class="sub-question">
                        <div class="question required">
                            <label>Ng√†y ly h√¥n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'divorceDate_LyHon', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseName_LyHon', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseId_LyHon', this.value)">
                        </div>
                    </div>
                `;
            } else if (hasDoc === 'DA_CO') {
                detailsDiv.innerHTML = `
                    <div class="sub-question">
                        <div class="question required">
                            <label>Ng√†y c·∫•p gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'xntthnDate_LyHon', this.value)">
                        </div>
                        <div class="question required">
                            <label>"KHO·∫¢NG TH·ªúI GIAN ƒë∆∞·ª£c x√°c nh·∫≠n" c√≥ t√≠nh t·ª´ th·ªùi ƒëi·ªÉm Ly h√¥n kh√¥ng?</label>
                            <select onchange="updateMaritalField(${ownerIndex}, 'xntthnTimeFromDivorce', this.value)">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="CO">C√≥</option>
                                <option value="KHONG">Kh√¥ng</option>
                            </select>
                        </div>
                        <div class="question required">
                            <label>Ng√†y ly h√¥n ƒë∆∞·ª£c ghi trong gi·∫•y x√°c nh·∫≠n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'divorceDateInXNTTHN', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseNameInXNTTHN', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng c≈©:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'exSpouseIdInXNTTHN', this.value)">
                        </div>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function renderDocThanVoChongChet(ownerIndex, container) {
            container.innerHTML = `
                <div class="question">
                    <label>ƒê√£ c√≥ gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n ch∆∞a?</label>
                    <select onchange="handleDocThanVoChongChetDocs(${ownerIndex}, this.value)">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="CHUA_CO">Ch∆∞a c√≥</option>
                        <option value="DA_CO">ƒê√£ c√≥</option>
                    </select>
                </div>
                <div id="doc-than-chet-details-${ownerIndex}"></div>
            `;
        }

        function handleDocThanVoChongChetDocs(ownerIndex, hasDoc) {
            const detailsDiv = document.getElementById(`doc-than-chet-details-${ownerIndex}`);
            updateMaritalField(ownerIndex, 'hasXNTTHN_Chet', hasDoc);
            
            if (hasDoc === 'CHUA_CO') {
                detailsDiv.innerHTML = `
                    <div class="sub-question">
                        <div class="question required">
                            <label>Ng√†y ch·∫øt c·ªßa v·ª£/ch·ªìng:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'spouseDeathDate', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng ƒë√£ ch·∫øt:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'deceasedSpouseName', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng ƒë√£ ch·∫øt:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'deceasedSpouseId', this.value)">
                        </div>
                    </div>
                `;
            } else if (hasDoc === 'DA_CO') {
                detailsDiv.innerHTML = `
                    <div class="sub-question">
                        <div class="question required">
                            <label>Ng√†y c·∫•p gi·∫•y x√°c nh·∫≠n t√¨nh tr·∫°ng h√¥n nh√¢n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'xntthnDate_Chet', this.value)">
                        </div>
                        <div class="question required">
                            <label>"KHO·∫¢NG TH·ªúI GIAN ƒë∆∞·ª£c x√°c nh·∫≠n" c√≥ t√≠nh t·ª´ th·ªùi ƒëi·ªÉm ch·∫øt c·ªßa v·ª£/ch·ªìng kh√¥ng?</label>
                            <select onchange="updateMaritalField(${ownerIndex}, 'xntthnTimeFromDeath', this.value)">
                                <option value="">-- Ch·ªçn --</option>
                                <option value="CO">C√≥</option>
                                <option value="KHONG">Kh√¥ng</option>
                            </select>
                        </div>
                        <div class="question required">
                            <label>Ng√†y ch·∫øt ƒë∆∞·ª£c ghi trong gi·∫•y x√°c nh·∫≠n:</label>
                            <input type="date" onchange="updateMaritalField(${ownerIndex}, 'deathDateInXNTTHN', this.value)">
                        </div>
                        <div class="question required">
                            <label>H·ªç t√™n v·ª£/ch·ªìng ƒë√£ ch·∫øt:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'deceasedSpouseNameInXNTTHN', this.value)">
                        </div>
                        <div class="question">
                            <label>S·ªë ƒë·ªãnh danh v·ª£/ch·ªìng ƒë√£ ch·∫øt:</label>
                            <input type="text" onchange="updateMaritalField(${ownerIndex}, 'deceasedSpouseIdInXNTTHN', this.value)">
                        </div>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function updateMaritalField(ownerIndex, field, value) {
            if (!appState.answers.maritalStatus[ownerIndex]) {
                appState.answers.maritalStatus[ownerIndex] = {};
            }
            appState.answers.maritalStatus[ownerIndex][field] = value;
        }

        // ===============================
        // SECTION A3: NƒÇNG L·ª∞C H√ÄNH VI
        // ===============================
        function renderCivilCapacityForms() {
            const container = document.getElementById('civil-capacity-forms');
            container.innerHTML = '';
            
            // Lo·∫°i giao d·ªãch
            container.innerHTML += `
                <div class="question-group">
                    <h3>Th√¥ng tin giao d·ªãch</h3>
                    <div class="question required">
                        <label>Lo·∫°i giao d·ªãch d·ª± ƒë·ªãnh th·ª±c hi·ªán:</label>
                        <select onchange="updateState('civilCapacity', this.value, 'transactionType')">
                            <option value="">-- Ch·ªçn lo·∫°i giao d·ªãch --</option>
                            <option value="TANG_CHO">T·∫∑ng cho</option>
                            <option value="BAN">B√°n</option>
                            <option value="CHUYEN_NHUONG">Chuy·ªÉn nh∆∞·ª£ng</option>
                            <option value="GOP_VON">G√≥p v·ªën</option>
                            <option value="THE_CHAP">Th·∫ø ch·∫•p</option>
                        </select>
                    </div>
                </div>
            `;
            
            // Ch·ªß s·ªü h·ªØu m·∫•t nƒÉng l·ª±c h√†nh vi
            container.innerHTML += `
                <div class="question-group">
                    <h3>NƒÉng l·ª±c h√†nh vi c·ªßa ch·ªß s·ªü h·ªØu</h3>
                    <div class="question required">
                        <label>Ch·ªß s·ªü h·ªØu c√≥ b·ªã m·∫•t nƒÉng l·ª±c h√†nh vi kh√¥ng?</label>
                        <select onchange="handleOwnerLostCapacity(this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="KHONG">Kh√¥ng</option>
                        </select>
                    </div>
                    <div id="owner-lost-capacity-details"></div>
                </div>
            `;
            
            // V·ª£/ch·ªìng ch·ªß s·ªü h·ªØu m·∫•t nƒÉng l·ª±c h√†nh vi
            container.innerHTML += `
                <div class="question-group">
                    <h3>NƒÉng l·ª±c h√†nh vi c·ªßa v·ª£/ch·ªìng ch·ªß s·ªü h·ªØu</h3>
                    <div class="question required">
                        <label>V·ª£/ch·ªìng c·ªßa ch·ªß s·ªü h·ªØu c√≥ b·ªã m·∫•t nƒÉng l·ª±c h√†nh vi kh√¥ng?</label>
                        <select onchange="handleSpouseLostCapacity(this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="KHONG">Kh√¥ng</option>
                        </select>
                    </div>
                    <div id="spouse-lost-capacity-details"></div>
                </div>
            `;
        }

        function handleOwnerLostCapacity(hasLostCapacity) {
            const detailsDiv = document.getElementById('owner-lost-capacity-details');
            updateState('civilCapacity', hasLostCapacity === 'CO', 'hasOwnerLostCapacity');
            
            if (hasLostCapacity === 'CO') {
                let html = '<div class="dynamic-content active">';
                
                // Ch·ªçn ch·ªß s·ªü h·ªØu b·ªã m·∫•t NLHV
                html += `<div class="question required">
                    <label>Ch·ªçn ch·ªß s·ªü h·ªØu b·ªã m·∫•t nƒÉng l·ª±c h√†nh vi:</label>
                    <div class="checkbox-group">`;
                
                appState.answers.owners.forEach((owner, index) => {
                    if (owner.type === 'CA_NHAN') {
                        html += `<div class="checkbox-item">
                            <input type="checkbox" id="owner-capacity-${index}" onchange="handleLostCapacitySelection('owners', ${index}, this.checked)">
                            <label for="owner-capacity-${index}">${owner.name || `Ch·ªß s·ªü h·ªØu ${index + 1}`}</label>
                        </div>`;
                    }
                });
                
                html += `</div></div>`;
                
                // Gi·∫•y t·ªù gi√°m h·ªô (chung cho t·∫•t c·∫£ ch·ªß s·ªü h·ªØu ƒë∆∞·ª£c ch·ªçn)
                html += `
                    <div class="question">
                        <label>Gi·∫•y tr√≠ch l·ª•c ƒëƒÉng k√Ω gi√°m h·ªô:</label>
                        <select onchange="updateState('civilCapacity', this.value, 'ownerDocuments', 'hasGuardianCert')">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div class="question">
                        <label>Gi·∫•y tr√≠ch l·ª•c ƒëƒÉng k√Ω gi√°m s√°t gi√°m h·ªô:</label>
                        <select onchange="updateState('civilCapacity', this.value, 'ownerDocuments', 'hasSupervisorCert')">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div class="question">
                        <label>VƒÉn b·∫£n ƒë·ªìng √Ω cho ƒë·ªãnh ƒëo·∫°t c·ªßa ng∆∞·ªùi gi√°m s√°t gi√°m h·ªô:</label>
                        <select onchange="handleGuardianAgreement('owner', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div id="owner-guardian-agreement-details"></div>
                </div>`;
                
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function handleLostCapacitySelection(type, index, isSelected) {
            const array = type === 'owners' ? appState.answers.civilCapacity.ownersLostCapacity : appState.answers.civilCapacity.spousesLostCapacity;
            
            if (isSelected) {
                if (!array.includes(index)) array.push(index);
            } else {
                const pos = array.indexOf(index);
                if (pos > -1) array.splice(pos, 1);
            }
        }

        function handleGuardianAgreement(who, hasAgreement) {
            const detailsDiv = document.getElementById(`${who}-guardian-agreement-details`);
            updateState('civilCapacity', hasAgreement, `${who}Documents`, 'hasGuardianAgreement');
            
            if (hasAgreement === 'CO') {
                detailsDiv.innerHTML = `
                    <div class="question">
                        <label>H√¨nh th·ª©c ch·ª©ng vƒÉn b·∫£n ƒë·ªìng √Ω:</label>
                        <select onchange="updateState('civilCapacity', this.value, '${who}Documents', 'agreementForm')">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CHUNG_THUC_CHU_KY">Ch·ª©ng th·ª±c ch·ªØ k√Ω</option>
                            <option value="CONG_CHUNG">C√¥ng ch·ª©ng</option>
                            <option value="CHUA_CHUNG">Ch∆∞a ƒë∆∞·ª£c ch·ª©ng</option>
                        </select>
                    </div>
                `;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function handleSpouseLostCapacity(hasLostCapacity) {
            const detailsDiv = document.getElementById('spouse-lost-capacity-details');
            updateState('civilCapacity', hasLostCapacity === 'CO', 'hasSpouseLostCapacity');
            
            if (hasLostCapacity === 'CO') {
                let html = '<div class="dynamic-content active">';
                
                // Ch·ªçn ch·ªß s·ªü h·ªØu c√≥ v·ª£/ch·ªìng b·ªã m·∫•t NLHV
                html += `<div class="question required">
                    <label>Ch·ªçn ch·ªß s·ªü h·ªØu c√≥ v·ª£/ch·ªìng b·ªã m·∫•t nƒÉng l·ª±c h√†nh vi:</label>
                    <div class="checkbox-group">`;
                
                appState.answers.owners.forEach((owner, index) => {
                    if (owner.type === 'CA_NHAN') {
                        html += `<div class="checkbox-item">
                            <input type="checkbox" id="spouse-capacity-${index}" onchange="handleLostCapacitySelection('spouses', ${index}, this.checked)">
                            <label for="spouse-capacity-${index}">${owner.name || `Ch·ªß s·ªü h·ªØu ${index + 1}`}</label>
                        </div>`;
                    }
                });
                
                html += `</div></div>`;
                
                // Gi·∫•y t·ªù gi√°m h·ªô cho v·ª£/ch·ªìng
                html += `
                    <div class="question">
                        <label>Gi·∫•y tr√≠ch l·ª•c ƒëƒÉng k√Ω gi√°m h·ªô (c·ªßa v·ª£/ch·ªìng):</label>
                        <select onchange="updateState('civilCapacity', this.value, 'spouseDocuments', 'hasGuardianCert')">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div class="question">
                        <label>Gi·∫•y tr√≠ch l·ª•c ƒëƒÉng k√Ω gi√°m s√°t gi√°m h·ªô (c·ªßa v·ª£/ch·ªìng):</label>
                        <select onchange="updateState('civilCapacity', this.value, 'spouseDocuments', 'hasSupervisorCert')">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div class="question">
                        <label>VƒÉn b·∫£n ƒë·ªìng √Ω cho ƒë·ªãnh ƒëo·∫°t c·ªßa ng∆∞·ªùi gi√°m s√°t gi√°m h·ªô (c·ªßa v·ª£/ch·ªìng):</label>
                        <select onchange="handleGuardianAgreement('spouse', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div id="spouse-guardian-agreement-details"></div>
                </div>`;
                
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        // ===============================
        // SECTION A4: TH√îNG TIN T·ªî CH·ª®C
        // ===============================
        function renderOrganizationForms() {
            const container = document.getElementById('organization-forms');
            container.innerHTML = '';
            
            let hasOrganization = false;
            
            appState.answers.owners.forEach((owner, index) => {
                if (owner.type === 'TO_CHUC') {
                    hasOrganization = true;
                    container.innerHTML += `
                        <div class="owner-card">
                            <h3>Th√¥ng tin t·ªï ch·ª©c - ${owner.orgName || `T·ªï ch·ª©c ${index + 1}`}</h3>
                            <div class="question">
                                <label>Gi·∫•y t·ªù ph√°p nh√¢n:</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="dkkd-${index}" onchange="handleOrganizationDocs(${index})">
                                        <label for="dkkd-${index}">ƒêƒÉng k√Ω kinh doanh</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="quyet-dinh-${index}" onchange="handleOrganizationDocs(${index})">
                                        <label for="quyet-dinh-${index}">Quy·∫øt ƒë·ªãnh/gi·∫•y ph√©p th√†nh l·∫≠p</label>
                                    </div>
                                </div>
                            </div>
                            <div class="question required">
                                <label>H·ªç t√™n ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t:</label>
                                <input type="text" onchange="updateOrganizationField(${index}, 'legalRepName', this.value)">
                            </div>
                            <div class="question">
                                <label>S·ªë ƒë·ªãnh danh ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t:</label>
                                <input type="text" onchange="updateOrganizationField(${index}, 'legalRepId', this.value)">
                            </div>
                            <div class="question required">
                                <label>Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t:</label>
                                <select onchange="updateOrganizationField(${index}, 'legalRepTitle', this.value)">
                                    <option value="">-- Ch·ªçn --</option>
                                    <option value="GIAM_DOC">Gi√°m ƒë·ªëc/T·ªïng gi√°m ƒë·ªëc</option>
                                    <option value="CHU_TICH_HDTV">Ch·ªß t·ªãch H·ªôi ƒë·ªìng th√†nh vi√™n</option>
                                    <option value="CHU_TICH_HDQT">Ch·ªß t·ªãch H·ªôi ƒë·ªìng qu·∫£n tr·ªã</option>
                                    <option value="CHU_TICH_CTY">Ch·ªß t·ªãch c√¥ng ty</option>
                                </select>
                            </div>
                            <div class="question required">
                                <label>Ng∆∞·ªùi tr·ª±c ti·∫øp k√Ω giao d·ªãch:</label>
                                <select onchange="updateOrganizationField(${index}, 'signatory', this.value)">
                                    <option value="">-- Ch·ªçn --</option>
                                    <option value="DAI_DIEN_PHAP_LUAT">Ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t</option>
                                    <option value="DAI_DIEN_UY_QUYEN">Ng∆∞·ªùi ƒë·∫°i di·ªán theo ·ªßy quy·ªÅn</option>
                                </select>
                            </div>
                            <div class="question required">
                                <label>Ph√™ duy·ªát/ch·∫•p nh·∫≠n c·ªßa t·ªï ch·ª©c ƒë·ªëi v·ªõi giao d·ªãch:</label>
                                <select onchange="updateOrganizationField(${index}, 'approval', this.value)">
                                    <option value="">-- Ch·ªçn --</option>
                                    <option value="DA_CO">ƒê√£ c√≥ Bi√™n b·∫£n/Ngh·ªã quy·∫øt/quy·∫øt ƒë·ªãnh</option>
                                    <option value="CHUA_CO">Ch∆∞a c√≥</option>
                                </select>
                            </div>
                        </div>
                    `;
                    
                    // Initialize organization info
                    if (!appState.answers.organizationInfo[index]) {
                        appState.answers.organizationInfo[index] = {};
                    }
                }
            });
            
            if (!hasOrganization) {
                container.innerHTML = '<p>Kh√¥ng c√≥ t·ªï ch·ª©c/doanh nghi·ªáp n√†o trong danh s√°ch ch·ªß s·ªü h·ªØu.</p>';
            }
        }

        function handleOrganizationDocs(orgIndex) {
            const hasDKKD = document.getElementById(`dkkd-${orgIndex}`).checked;
            const hasQuyetDinh = document.getElementById(`quyet-dinh-${orgIndex}`).checked;
            
            if (!appState.answers.organizationInfo[orgIndex]) {
                appState.answers.organizationInfo[orgIndex] = {};
            }
            
            appState.answers.organizationInfo[orgIndex].hasDKKD = hasDKKD;
            appState.answers.organizationInfo[orgIndex].hasQuyetDinh = hasQuyetDinh;
        }

        function updateOrganizationField(orgIndex, field, value) {
            if (!appState.answers.organizationInfo[orgIndex]) {
                appState.answers.organizationInfo[orgIndex] = {};
            }
            appState.answers.organizationInfo[orgIndex][field] = value;
        }

        // ===============================
        // SECTION A5: ·ª¶Y QUY·ªÄN
        // ===============================
        function renderPowerOfAttorneyForms() {
            const container = document.getElementById('power-of-attorney-forms');
            container.innerHTML = '';
            
            // ·ª¶y quy·ªÅn c·ªßa ch·ªß s·ªü h·ªØu
            container.innerHTML += `
                <div class="question-group">
                    <h3>·ª¶y quy·ªÅn c·ªßa ch·ªß s·ªü h·ªØu</h3>
                    <div class="question required">
                        <label>Ch·ªß s·ªü h·ªØu ƒë√£ ·ªßy quy·ªÅn cho ng∆∞·ªùi kh√°c?</label>
                        <select onchange="handleOwnerPowerOfAttorney(this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div id="owner-power-of-attorney-details"></div>
                </div>
            `;
            
            // ·ª¶y quy·ªÅn c·ªßa v·ª£/ch·ªìng ch·ªß s·ªü h·ªØu
            container.innerHTML += `
                <div class="question-group">
                    <h3>·ª¶y quy·ªÅn c·ªßa v·ª£/ch·ªìng ch·ªß s·ªü h·ªØu</h3>
                    <div class="question required">
                        <label>V·ª£/ch·ªìng ch·ªß s·ªü h·ªØu ƒë√£ ·ªßy quy·ªÅn cho ng∆∞·ªùi kh√°c?</label>
                        <select onchange="handleSpousePowerOfAttorney(this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div id="spouse-power-of-attorney-details"></div>
                </div>
            `;
        }

        function handleOwnerPowerOfAttorney(hasPOA) {
            const detailsDiv = document.getElementById('owner-power-of-attorney-details');
            updateState('powerOfAttorney', hasPOA === 'CO', 'hasOwnerPOA');
            
            if (hasPOA === 'CO') {
                let html = '<div class="dynamic-content active">';
                
                // Ch·ªçn ch·ªß s·ªü h·ªØu c√≥ ·ªßy quy·ªÅn
                html += `<div class="question required">
                    <label>Ch·ªçn ch·ªß s·ªü h·ªØu ƒë√£ ·ªßy quy·ªÅn:</label>
                    <div class="checkbox-group">`;
                
                appState.answers.owners.forEach((owner, index) => {
                    if (owner.type === 'CA_NHAN') {
                        html += `<div class="checkbox-item">
                            <input type="checkbox" id="owner-poa-${index}" onchange="handlePOASelection('owners', ${index}, this.checked)">
                            <label for="owner-poa-${index}">${owner.name || `Ch·ªß s·ªü h·ªØu ${index + 1}`}</label>
                        </div>`;
                    }
                });
                
                html += `</div></div>`;
                
                // Th√¥ng tin ·ªßy quy·ªÅn
                html += `
                    <div class="question required">
                        <label>H·ªç t√™n ng∆∞·ªùi ƒë∆∞·ª£c ·ªßy quy·ªÅn:</label>
                        <input type="text" onchange="updatePOAField('ownerInfo', 'authorizedPerson', this.value)">
                    </div>
                    <div class="question required">
                        <label>·ª¶y quy·ªÅn c√≥ n·ªôi dung cho ph√©p th·ª±c hi·ªán giao d·ªãch ƒëang y√™u c·∫ßu?</label>
                        <select onchange="updatePOAField('ownerInfo', 'hasTransactionContent', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Th·ªùi h·∫°n ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('ownerInfo', 'durationType', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CHO_DEN_KHI_HOAN_THANH">Cho ƒë·∫øn khi th·ª±c hi·ªán xong</option>
                            <option value="CHO_DEN_NGAY">Cho ƒë·∫øn ng√†y...</option>
                            <option value="KHOANG_THOI_GIAN">X√°c ƒë·ªãnh 1 kho·∫£ng th·ªùi h·∫°n c·ª• th·ªÉ</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Lo·∫°i t√†i s·∫£n ƒë∆∞·ª£c ghi trong ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('ownerInfo', 'propertyType', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="NHA_VA_DAT">Nh√† v√† ƒë·∫•t</option>
                            <option value="CHI_NHA">Ch·ªâ c√≥ nh√†</option>
                            <option value="CHI_DAT">Ch·ªâ c√≥ ƒë·∫•t</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Ph·∫°m vi t√†i s·∫£n ƒë∆∞·ª£c ghi trong ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('ownerInfo', 'propertyScope', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="PHAN">Ph·∫ßn/1 ph·∫ßn</option>
                            <option value="TOAN_BO">To√†n b·ªô</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>H√¨nh th·ª©c l·∫≠p vƒÉn b·∫£n ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('ownerInfo', 'form', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CONG_CHUNG">C√¥ng ch·ª©ng</option>
                            <option value="CHUNG_THUC_HOP_DONG">Ch·ª©ng th·ª±c h·ª£p ƒë·ªìng</option>
                            <option value="CHUNG_THUC_CHU_KY">Ch·ª©ng th·ª±c ch·ªØ k√Ω</option>
                            <option value="CHUA_CHUNG">Ch∆∞a ch·ª©ng</option>
                        </select>
                    </div>
                </div>`;
                
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        function handlePOASelection(type, index, isSelected) {
            const array = type === 'owners' ? appState.answers.powerOfAttorney.owners : appState.answers.powerOfAttorney.spouses;
            
            if (isSelected) {
                if (!array.includes(index)) array.push(index);
            } else {
                const pos = array.indexOf(index);
                if (pos > -1) array.splice(pos, 1);
            }
        }

        function updatePOAField(infoType, field, value) {
            const target = infoType === 'ownerInfo' ? appState.answers.powerOfAttorney.ownerInfo : appState.answers.powerOfAttorney.spouseInfo;
            
            if (!target) {
                if (infoType === 'ownerInfo') {
                    appState.answers.powerOfAttorney.ownerInfo = {};
                } else {
                    appState.answers.powerOfAttorney.spouseInfo = {};
                }
            }
            
            if (infoType === 'ownerInfo') {
                if (!appState.answers.powerOfAttorney.ownerInfo) {
                    appState.answers.powerOfAttorney.ownerInfo = {};
                }
                appState.answers.powerOfAttorney.ownerInfo[field] = value;
            } else {
                if (!appState.answers.powerOfAttorney.spouseInfo) {
                    appState.answers.powerOfAttorney.spouseInfo = {};
                }
                appState.answers.powerOfAttorney.spouseInfo[field] = value;
            }
        }

        function handleSpousePowerOfAttorney(hasPOA) {
            const detailsDiv = document.getElementById('spouse-power-of-attorney-details');
            updateState('powerOfAttorney', hasPOA === 'CO', 'hasSpousePOA');
            
            if (hasPOA === 'CO') {
                let html = '<div class="dynamic-content active">';
                
                // Ch·ªçn ch·ªß s·ªü h·ªØu c√≥ v·ª£/ch·ªìng ·ªßy quy·ªÅn
                html += `<div class="question required">
                    <label>Ch·ªçn ch·ªß s·ªü h·ªØu c√≥ v·ª£/ch·ªìng ƒë√£ ·ªßy quy·ªÅn:</label>
                    <div class="checkbox-group">`;
                
                appState.answers.owners.forEach((owner, index) => {
                    if (owner.type === 'CA_NHAN') {
                        html += `<div class="checkbox-item">
                            <input type="checkbox" id="spouse-poa-${index}" onchange="handlePOASelection('spouses', ${index}, this.checked)">
                            <label for="spouse-poa-${index}">${owner.name || `Ch·ªß s·ªü h·ªØu ${index + 1}`}</label>
                        </div>`;
                    }
                });
                
                html += `</div></div>`;
                
                // Th√¥ng tin ·ªßy quy·ªÅn c·ªßa v·ª£/ch·ªìng
                html += `
                    <div class="question required">
                        <label>H·ªç t√™n ng∆∞·ªùi ƒë∆∞·ª£c ·ªßy quy·ªÅn:</label>
                        <input type="text" onchange="updatePOAField('spouseInfo', 'authorizedPerson', this.value)">
                    </div>
                    <div class="question required">
                        <label>·ª¶y quy·ªÅn c√≥ n·ªôi dung cho ph√©p th·ª±c hi·ªán giao d·ªãch ƒëang y√™u c·∫ßu?</label>
                        <select onchange="updatePOAField('spouseInfo', 'hasTransactionContent', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CO">C√≥</option>
                            <option value="CHUA">Ch∆∞a c√≥</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Th·ªùi h·∫°n ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('spouseInfo', 'durationType', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CHO_DEN_KHI_HOAN_THANH">Cho ƒë·∫øn khi th·ª±c hi·ªán xong</option>
                            <option value="CHO_DEN_NGAY">Cho ƒë·∫øn ng√†y...</option>
                            <option value="KHOANG_THOI_GIAN">X√°c ƒë·ªãnh 1 kho·∫£ng th·ªùi h·∫°n c·ª• th·ªÉ</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Lo·∫°i t√†i s·∫£n ƒë∆∞·ª£c ghi trong ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('spouseInfo', 'propertyType', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="NHA_VA_DAT">Nh√† v√† ƒë·∫•t</option>
                            <option value="CHI_NHA">Ch·ªâ c√≥ nh√†</option>
                            <option value="CHI_DAT">Ch·ªâ c√≥ ƒë·∫•t</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>Ph·∫°m vi t√†i s·∫£n ƒë∆∞·ª£c ghi trong ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('spouseInfo', 'propertyScope', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="PHAN">Ph·∫ßn/1 ph·∫ßn</option>
                            <option value="TOAN_BO">To√†n b·ªô</option>
                        </select>
                    </div>
                    <div class="question required">
                        <label>H√¨nh th·ª©c l·∫≠p vƒÉn b·∫£n ·ªßy quy·ªÅn:</label>
                        <select onchange="updatePOAField('spouseInfo', 'form', this.value)">
                            <option value="">-- Ch·ªçn --</option>
                            <option value="CONG_CHUNG">C√¥ng ch·ª©ng</option>
                            <option value="CHUNG_THUC_HOP_DONG">Ch·ª©ng th·ª±c h·ª£p ƒë·ªìng</option>
                            <option value="CHUNG_THUC_CHU_KY">Ch·ª©ng th·ª±c ch·ªØ k√Ω</option>
                            <option value="CHUA_CHUNG">Ch∆∞a ch·ª©ng</option>
                        </select>
                    </div>
                </div>`;
                
                detailsDiv.innerHTML = html;
            } else {
                detailsDiv.innerHTML = '';
            }
        }

        // ===============================
        // GUIDANCE GENERATION - ƒê·∫¶Y ƒê·ª¶ LOGIC
        // ===============================
        function generateGuidance() {
            appState.guidance = [];
            
            // 1. Ki·ªÉm tra c∆° b·∫£n - Giai ƒëo·∫°n A1
            if (appState.answers.hasCertificate === 'CHUA') {
                appState.guidance.push({
                    type: 'error',
                    message: 'HS KH√îNG ƒê·ª¶ ƒêI·ªÄU KI·ªÜN ƒê·ªÇ C√îNG CH·ª®NG - Ch∆∞a c√≥ Gi·∫•y ch·ª©ng nh·∫≠n QSDƒê/QSHN'
                });
                displayGuidance();
                return;
            }

            // 2. Ph√¢n t√≠ch t·ª´ng ch·ªß s·ªü h·ªØu
            appState.answers.owners.forEach((owner, index) => {
                if (owner.type === 'CA_NHAN') {
                    analyzeIndividualOwner(owner, index);
                } else if (owner.type === 'TO_CHUC') {
                    analyzeOrganizationOwner(owner, index);
                }
            });
            
            // 3. Ph√¢n t√≠ch c√°c ƒëi·ªÅu ki·ªán b·ªï sung
            analyzeCivilCapacityGuidance();
            analyzePowerOfAttorneyGuidance();
            
            displayGuidance();
        }

        function analyzeIndividualOwner(owner, index) {
            const age = calculateAge(new Date(owner.birthDate));
            const maritalStatus = appState.answers.maritalStatus[index];
            const ownershipDate = new Date(appState.answers.ownershipDate);
            
            // Ph√¢n t√≠ch theo ƒë·ªô tu·ªïi - B.1
            if (age < 9) {
                appState.guidance.push({
                    type: 'info',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng" & "Ng∆∞·ªùi k√Ω vƒÉn b·∫£n l√† Cha & M·∫π c·ªßa tr·∫ª" & "B·ªï sung gi·∫•y Khai sinh tr·∫ª & CCCD c·ªßa cha m·∫π tr·∫ª"`
                });
            } else if (age >= 9 && age < 15) {
                appState.guidance.push({
                    type: 'info',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng" & "Ng∆∞·ªùi k√Ω vƒÉn b·∫£n l√† Cha & M·∫π c·ªßa tr·∫ª" & "B·ªï sung gi·∫•y Khai sinh tr·∫ª & CCCD c·ªßa cha m·∫π tr·∫ª & vƒÉn b·∫£n ƒë·ªìng √Ω c·ªßa tr·∫ª (ƒë∆∞·ª£c ch·ª©ng n·ªôi dung)/CCCD tr·∫ª k√Ω chung"`
                });
            } else if (age >= 15 && age < 18) {
                appState.guidance.push({
                    type: 'info',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng" & "Ng∆∞·ªùi k√Ω vƒÉn b·∫£n l√† tr·∫ª" & "CCCD tr·∫ª; B·ªï sung gi·∫•y Khai sinh tr·∫ª & CCCD c·ªßa cha m·∫π tr·∫ª k√Ω chung/vƒÉn b·∫£n ƒë·ªìng √Ω c·ªßa cha m·∫π (ƒë∆∞·ª£c ch·ª©ng n·ªôi dung)"`
                });
            } else {
                // Ph√¢n t√≠ch theo t√¨nh tr·∫°ng h√¥n nh√¢n cho ng∆∞·ªùi tr√™n 18 tu·ªïi
                analyzeMaritalStatusForGuidance(owner, index, maritalStatus, ownershipDate);
            }
        }

        function analyzeMaritalStatusForGuidance(owner, index, maritalStatus, ownershipDate) {
            if (!maritalStatus || !maritalStatus.status) {
                appState.guidance.push({
                    type: 'warning',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): Ch∆∞a cung c·∫•p ƒë·∫ßy ƒë·ªß th√¥ng tin t√¨nh tr·∫°ng h√¥n nh√¢n`
                });
                return;
            }
            
            switch(maritalStatus.status) {
                case 'CHUA_TUNG_KET_HON':
                    analyzeChuaTungKetHon(owner, index, maritalStatus, ownershipDate);
                    break;
                case 'DANG_CO_VO_CHONG_LAN_DAU':
                    analyzeDangCoVoChongLanDau(owner, index, maritalStatus, ownershipDate);
                    break;
                case 'DANG_CO_VO_CHONG_TAI_HON':
                    analyzeDangCoVoChongTaiHon(owner, index, maritalStatus, ownershipDate);
                    break;
                case 'DOC_THAN_DA_LY_HON':
                    analyzeDocThanDaLyHon(owner, index, maritalStatus, ownershipDate);
                    break;
                case 'DOC_THAN_VO_CHONG_CHET':
                    analyzeDocThanVoChongChet(owner, index, maritalStatus, ownershipDate);
                    break;
            }
        }

        function analyzeChuaTungKetHon(owner, index, maritalStatus, ownershipDate) {
            // Logic t·ª´ k·ªãch b·∫£n B.1
            if (maritalStatus.hasXNTTHN === 'DA_CO') {
                const xntthnDate = new Date(maritalStatus.xntthnDate);
                const sixMonthsLater = new Date(xntthnDate);
                sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
                
                // Ki·ªÉm tra th·ªùi h·∫°n XNTTHN
                if (sixMonthsLater < new Date()) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "n·∫øu XNTTHN qu√° 6 th√°ng th√¨ ph·∫£i l√†m l·∫°i"`
                    });
                }
                
                if (maritalStatus.xntthnContent === 'CHI_HIEN_TAI') {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng c·ªßa ${owner.name}" & "xu·∫•t tr√¨nh CCCD & Gi·∫•y XNTTHN"`
                    });
                } else if (maritalStatus.xntthnContent === 'VUA_CO_KHOANG_THOI_GIAN') {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "c·∫ßn x√°c nh·∫≠n TTHN cho to√†n b·ªô th·ªùi gian t·ª´ khi ƒë·ªß tu·ªïi k·∫øt h√¥n ƒë·∫øn nay, n·∫øu ch∆∞a ƒë·ªß"`
                    });
                }
            } else {
                appState.guidance.push({
                    type: 'warning',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "b·ªï sung gi·∫•y x√°c nh·∫≠n TTHN k·ªÉ t·ª´ khi ƒë·ªß tu·ªïi k·∫øt h√¥n cho ƒë·∫øn nay, ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ h∆°n"`
                });
            }
        }

        function analyzeDangCoVoChongLanDau(owner, index, maritalStatus, ownershipDate) {
            if (maritalStatus.hasGCNKH && maritalStatus.effectiveDate) {
                const effectiveDate = new Date(maritalStatus.effectiveDate);
                
                if (effectiveDate <= ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n chung v·ªõi V·ª£/ch·ªìng" & "CCCD c·ªßa ${owner.name} v√† ${maritalStatus.spouseName}, k√Ω chung"`
                    });
                } else if (effectiveDate > ownershipDate && !maritalStatus.hasXNTTTHN) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "CH∆ØA ƒê·ª¶ C∆† S·ªû X√ÅC ƒê·ªäNH T√åNH TR·∫†NG S·ªû H·ªÆU" & "C·∫¶N B·ªî SUNG b·ªï sung l·∫°i XNTTHN do thi·∫øu th·ªùi gian t·ª´ ${formatDate(effectiveDate)} ƒë·∫øn ${formatDate(ownershipDate)}"`
                    });
                } else if (effectiveDate > ownershipDate && maritalStatus.hasXNTTTHN) {
                    const xntthnDate = new Date(maritalStatus.xntthnDate2);
                    const sixMonthsLater = new Date(xntthnDate);
                    sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
                    
                    if (sixMonthsLater < new Date()) {
                        appState.guidance.push({
                            type: 'warning',
                            message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "n·∫øu XNTTHN qu√° 6 th√°ng th√¨ ph·∫£i l√†m l·∫°i"`
                        });
                    }
                    
                    if (maritalStatus.xntthnContent2 === 'CHI_HIEN_TAI') {
                        appState.guidance.push({
                            type: 'info',
                            message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng" & "xu·∫•t tr√¨nh CCCD & Gi·∫•y XNTTHN & Gi·∫•y k·∫øt h√¥n"`
                        });
                    } else if (maritalStatus.xntthnContent2 === 'VUA_CO_KHOANG_THOI_GIAN') {
                        appState.guidance.push({
                            type: 'warning',
                            message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "c·∫ßn x√°c nh·∫≠n TTHN cho to√†n b·ªô th·ªùi gian t·ª´ khi ƒë·ªß tu·ªïi k·∫øt h√¥n ƒë·∫øn nay, n·∫øu ch∆∞a ƒë·ªß"`
                        });
                    }
                }
            }
            
            if (maritalStatus.hasNoDocs) {
                appState.guidance.push({
                    type: 'warning',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "Ph·∫£i b·ªï sung Gi·∫•y k·∫øt h√¥n & XNTTHN (n·∫øu c·∫ßn) ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ h∆°n"`
                });
            }
        }

        function analyzeDangCoVoChongTaiHon(owner, index, maritalStatus, ownershipDate) {
            const effectiveDate = maritalStatus.currentMarriageEffectiveDate ? new Date(maritalStatus.currentMarriageEffectiveDate) : null;
            const divorceDate = maritalStatus.divorceDate ? new Date(maritalStatus.divorceDate) : null;
            const deathDate = maritalStatus.exSpouseDeathDate ? new Date(maritalStatus.exSpouseDeathDate) : null;
            
            if (maritalStatus.hasCurrentGCNKH && effectiveDate) {
                if (effectiveDate <= ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n chung v·ªõi V·ª£/ch·ªìng" & "CCCD c·ªßa ${owner.name} v√† ${maritalStatus.currentSpouseName}, k√Ω chung"`
                    });
                } else if (effectiveDate > ownershipDate) {
                    const eventDate = divorceDate || deathDate;
                    if (eventDate && eventDate < ownershipDate) {
                        appState.guidance.push({
                            type: 'info',
                            message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "KH·∫¢ NƒÇNG T√†i s·∫£n ri√™ng" & "xu·∫•t tr√¨nh CCCD ${owner.name} & Gi·∫•y XNTTHN cho th·ªùi ƒëi·ªÉm tr∆∞·ªõc k·∫øt h√¥n & Gi·∫•y k·∫øt h√¥n ƒê·ªÇ CH·ª®NG MINH"`
                        });
                    } else if (eventDate && eventDate >= ownershipDate) {
                        appState.guidance.push({
                            type: 'info',
                            message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "KH·∫¢ NƒÇNG T√†i s·∫£n chung v·ªõi v·ª£/ch·ªìng c≈©" & "xu·∫•t tr√¨nh th√™m CCCD v·ª£/ch·ªìng c≈© k√Ω chung ho·∫∑c ph√¢n chia di s·∫£n c·ªßa v·ª£ ch·ªìng c≈© ƒë·ªÉ c√πng c√°c th·ª´a k·∫ø k√Ω chung"`
                        });
                    }
                }
            }
            
            // X·ª≠ l√Ω logic cho XNTTHN tr∆∞·ªõc k·∫øt h√¥n
            if (maritalStatus.hasPreMarriageXNTTTHN) {
                const xntthnDate = new Date(maritalStatus.preMarriageXNTTHNDate);
                const sixMonthsLater = new Date(xntthnDate);
                sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
                
                if (sixMonthsLater < new Date()) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "n·∫øu XNTTHN qu√° 6 th√°ng th√¨ ph·∫£i l√†m l·∫°i"`
                    });
                }
                
                if (maritalStatus.preMarriageTimeFromEvent === 'KHONG') {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "Ph·∫£i x√°c nh·∫≠n th√™m TTHN ƒë·ªëi v·ªõi kho·∫£ng th·ªùi gian c√≤n l·∫°i, ƒë·ªÉ ch·ª©ng minh KH·∫¢ NƒÇNG t√†i s·∫£n/chung ri√™ng l√† ƒê√öNG"`
                    });
                } else if (maritalStatus.preMarriageTimeFromEvent === 'CO') {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "KH·∫¢ NƒÇNG t√†i s·∫£n/chung ri√™ng l√† ƒê√öNG"`
                    });
                }
            }
            
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ch·ªâ c√≥ XNTTHN
            if (maritalStatus.hasPreMarriageXNTTTHN && !maritalStatus.hasCurrentGCNKH && !maritalStatus.hasNoDocsTaiHon) {
                // Logic t∆∞∆°ng t·ª± nh∆∞ tr√™n nh∆∞ng y√™u c·∫ßu b·ªï sung gi·∫•y k·∫øt h√¥n
                appState.guidance.push({
                    type: 'warning',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "b·ªï sung gi·∫•y ch·ª©ng nh·∫≠n k·∫øt h√¥n"`
                });
            }
        }

        function analyzeDocThanDaLyHon(owner, index, maritalStatus, ownershipDate) {
            const divorceDate = maritalStatus.divorceDate_LyHon ? new Date(maritalStatus.divorceDate_LyHon) : 
                              maritalStatus.divorceDateInXNTTHN ? new Date(maritalStatus.divorceDateInXNTTHN) : null;
            
            if (maritalStatus.hasXNTTHN_LyHon === 'CHUA_CO') {
                if (divorceDate >= ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n chung v·ªõi V·ª£/ch·ªìng c≈©" & "CCCD c·ªßa ${owner.name} v√† ${maritalStatus.exSpouseName_LyHon}, k√Ω chung" & "Ph·∫£i b·ªï sung Gi·∫•y XNTTHN ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ h∆°n"`
                    });
                } else if (divorceDate < ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "C√ì TH·ªÇ l√† t√†i s·∫£n ri√™ng" & "xu·∫•t tr√¨nh CCCD & Gi·∫•y XNTTHN" & "Ph·∫£i b·ªï sung Gi·∫•y XNTTHN ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ h∆°n"`
                    });
                }
            } else if (maritalStatus.hasXNTTHN_LyHon === 'DA_CO') {
                const xntthnDate = new Date(maritalStatus.xntthnDate_LyHon);
                const sixMonthsLater = new Date(xntthnDate);
                sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
                
                if (sixMonthsLater < new Date()) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "n·∫øu XNTTHN qu√° 6 th√°ng th√¨ ph·∫£i l√†m l·∫°i"`
                    });
                }
                
                if (divorceDate >= ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n chung v·ªõi V·ª£/ch·ªìng c≈©" & "CCCD c·ªßa ${owner.name} v√† ${maritalStatus.exSpouseNameInXNTTHN}, k√Ω chung"`
                    });
                } else if (divorceDate < ownershipDate && ownershipDate <= xntthnDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng" & "xu·∫•t tr√¨nh CCCD & Gi·∫•y XNTTHN"`
                    });
                } else if (divorceDate < xntthnDate && xntthnDate < ownershipDate) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "CH∆ØA ƒê·ª¶ C∆† S·ªû X√ÅC ƒê·ªäNH T√åNH TR·∫†NG S·ªû H·ªÆU" & "C·∫¶N B·ªî SUNG b·ªï sung l·∫°i XNTTHN do thi·∫øu th·ªùi gian t·ª´ ${formatDate(xntthnDate)} ƒë·∫øn ${formatDate(ownershipDate)}"`
                    });
                }
                
                if (maritalStatus.xntthnTimeFromDivorce === 'KHONG') {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "Ph·∫£i x√°c nh·∫≠n th√™m TTHN ƒë·ªëi v·ªõi kho·∫£ng th·ªùi gian c√≤n l·∫°i"`
                    });
                }
            }
            
            if (maritalStatus.isPropertyWithExSpouse === 'CO') {
                appState.guidance.push({
                    type: 'info',
                    message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "Ph·∫£i c√≥ s·ª± tham d·ª±/·ªßy quy·ªÅn c·ªßa v·ª£ ch·ªìng c≈©, n·∫øu √°n ly h√¥n kh√¥ng chia t√†i s·∫£n n√†y cho ng∆∞·ªùi ƒë·ª©ng t√™n tr√™n GCN"`
                });
            }
        }

        function analyzeDocThanVoChongChet(owner, index, maritalStatus, ownershipDate) {
            const deathDate = maritalStatus.spouseDeathDate ? new Date(maritalStatus.spouseDeathDate) : 
                            maritalStatus.deathDateInXNTTHN ? new Date(maritalStatus.deathDateInXNTTHN) : null;
            
            if (maritalStatus.hasXNTTHN_Chet === 'CHUA_CO') {
                if (deathDate >= ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n chung v·ªõi V·ª£/ch·ªìng c≈©" & "ph·∫£i ph√¢n chia di s·∫£n, ƒëƒÉng k√Ω s·ªü h·ªØu & k√Ω chung v·ªõi c√°c th·ª´a k·∫ø" & "Ph·∫£i b·ªï sung Gi·∫•y XNTTHN ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ h∆°n"`
                    });
                } else if (deathDate < ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "C√ì TH·ªÇ l√† T√†i s·∫£n ri√™ng c·ªßa ${owner.name}" & "xu·∫•t tr√¨nh CCCD & Gi·∫•y XNTTHN" & "Ph·∫£i b·ªï sung Gi·∫•y XNTTHN ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ h∆°n"`
                    });
                }
            } else if (maritalStatus.hasXNTTHN_Chet === 'DA_CO') {
                const xntthnDate = new Date(maritalStatus.xntthnDate_Chet);
                const sixMonthsLater = new Date(xntthnDate);
                sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
                
                if (sixMonthsLater < new Date()) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "n·∫øu XNTTHN qu√° 6 th√°ng th√¨ ph·∫£i l√†m l·∫°i"`
                    });
                }
                
                if (deathDate >= ownershipDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n chung v·ªõi V·ª£/ch·ªìng c≈©" & "ph·∫£i ph√¢n chia di s·∫£n, ƒëƒÉng k√Ω s·ªü h·ªØu & k√Ω chung v·ªõi c√°c th·ª´a k·∫ø"`
                    });
                } else if (deathDate < ownershipDate && ownershipDate <= xntthnDate) {
                    appState.guidance.push({
                        type: 'info',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "T√†i s·∫£n ri√™ng c·ªßa ${owner.name}" & "xu·∫•t tr√¨nh CCCD & Gi·∫•y XNTTHN"`
                    });
                } else if (deathDate < xntthnDate && xntthnDate < ownershipDate) {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "CH∆ØA ƒê·ª¶ C∆† S·ªû X√ÅC ƒê·ªäNH T√åNH TR·∫†NG S·ªû H·ªÆU" & "C·∫¶N B·ªî SUNG b·ªï sung l·∫°i XNTTHN do thi·∫øu th·ªùi gian t·ª´ ${formatDate(xntthnDate)} ƒë·∫øn ${formatDate(ownershipDate)}"`
                    });
                }
                
                if (maritalStatus.xntthnTimeFromDeath === 'KHONG') {
                    appState.guidance.push({
                        type: 'warning',
                        message: `Ch·ªß s·ªü h·ªØu ${index + 1} (${owner.name}): "Ph·∫£i x√°c nh·∫≠n th√™m TTHN ƒë·ªëi v·ªõi kho·∫£ng th·ªùi gian c√≤n l·∫°i"`
                    });
                }
            }
        }

        function analyzeOrganizationOwner(owner, index) {
            const orgInfo = appState.answers.organizationInfo[index];
            
            if (orgInfo) {
                // B.3.1 - Ng∆∞·ªùi k√Ω vƒÉn b·∫£n
                if (orgInfo.signatory === 'DAI_DIEN_PHAP_LUAT') {
                    appState.guidance.push({
                        type: 'info',
                        message: `T·ªï ch·ª©c ${owner.orgName}: "CCCD c·ªßa ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t + con d·∫•u ƒë·ªÉ tr·ª±c ti·∫øp k√Ω, ƒë√≥ng d·∫•u"`
                    });
                } else if (orgInfo.signatory === 'DAI_DIEN_UY_QUYEN') {
                    appState.guidance.push({
                        type: 'info',
                        message: `T·ªï ch·ª©c ${owner.orgName}: "CCCD c·ªßa ng∆∞·ªùi ƒë·∫°i di·ªán theo ·ªßy quy·ªÅn & VƒÉn b·∫£n ·ªßy quy·ªÅn t·ª´ ng∆∞·ªùi ƒë·∫°i di·ªán theo ph√°p lu·∫≠t c√≥ n·ªôi dung ph√π h·ª£p v·ªõi giao d·ªãch y√™u c·∫ßu + d·∫•u + Quy·∫øt ƒë·ªãnh b·ªï nhi·ªám"`
                    });
                }
                
                // B.3.3 - Ph√™ duy·ªát n·ªôi b·ªô
                if (orgInfo.approval === 'CHUA_CO') {
                    appState.guidance.push({
                        type: 'warning',
                        message: `T·ªï ch·ª©c ${owner.orgName}: "C·∫ßn b·ªï sung Bi√™n b·∫£n/quy·∫øt ƒë·ªãnh, t√πy thu·ªôc ph√¢n c·∫•p th·∫©m quy·ªÅn cho ph√©p th·ª±c hi·ªán giao d·ªãch c·ªßa c·∫•p c√≥ th·∫©m quy·ªÅn_c·∫ßn li√™n h·ªá tr·ª±c ti·∫øp ƒë·ªÉ ƒë∆∞·ª£c h∆∞·ªõng d·∫´n c·ª• th·ªÉ"`
                    });
                } else if (orgInfo.approval === 'DA_CO') {
                    appState.guidance.push({
                        type: 'info',
                        message: `T·ªï ch·ª©c ${owner.orgName}: "C·∫ßn li√™n h·ªá tr·ª±c ti·∫øp ƒë·ªÉ h∆∞·ªõng d·∫´n/xem x√©t v·ªÅ th·∫©m quy·ªÅn th√¥ng qua bi√™n b·∫£n/quy·∫øt ƒë·ªãnh ƒë√£ ph√π h·ª£p ch∆∞a"`
                    });
                }
            }
        }

        function analyzeCivilCapacityGuidance() {
            const civilCapacity = appState.answers.civilCapacity;
            
            // B.2.1 v√† B.2.3 - Ki·ªÉm tra t·∫∑ng cho v·ªõi ng∆∞·ªùi m·∫•t NLHV
            if (civilCapacity.transactionType === 'TANG_CHO') {
                if (civilCapacity.ownersLostCapacity.length > 0) {
                    appState.guidance.push({
                        type: 'error',
                        message: 'B.2.1: "kh√¥ng ƒë∆∞·ª£c ph√©p t·∫∑ng cho t√†i s·∫£n c·ªßa ng∆∞·ªùi ƒë∆∞·ª£c gi√°m h·ªô ‚Üí T·ª™ CH·ªêI H·ªí S∆†"'
                    });
                }
                
                if (civilCapacity.spousesLostCapacity.length > 0) {
                    appState.guidance.push({
                        type: 'error',
                        message: 'B.2.3: "kh√¥ng ƒë∆∞·ª£c ph√©p t·∫∑ng cho t√†i s·∫£n c·ªßa ng∆∞·ªùi ƒë∆∞·ª£c gi√°m h·ªô, n·∫øu v·ª£/ch·ªìng ƒë∆∞·ª£c x√°c ƒë·ªãnh ph·∫£i k√Ω chung ‚Üí T·ª™ CH·ªêI H·ªí S∆†"'
                    });
                }
            }
            
            // B.2.2 - X·ª≠ l√Ω gi√°m h·ªô cho ch·ªß s·ªü h·ªØu
            if (civilCapacity.ownersLostCapacity.length > 0 && civilCapacity.transactionType !== 'TANG_CHO') {
                civilCapacity.ownersLostCapacity.forEach(ownerIndex => {
                    const owner = appState.answers.owners[ownerIndex];
                    const docs = civilCapacity.ownerDocuments;
                    
                    if (docs.hasGuardianCert === 'CHUA') {
                        appState.guidance.push({
                            type: 'warning',
                            message: `Ch·ªß s·ªü h·ªØu ${owner.name}: "li√™n h·ªá v·ªõi UBND ƒë·ªÉ b·ªï sung Tr√≠ch l·ª•c ƒëƒÉng k√Ω gi√°m h·ªô"`
                        });
                    }
                    
                    if (docs.hasSupervisorCert === 'CHUA') {
                        appState.guidance.push({
                            type: 'warning',
                            message: `Ch·ªß s·ªü h·ªØu ${owner.name}: "li√™n h·ªá v·ªõi UBND ƒë·ªÉ b·ªï sung Tr√≠ch l·ª•c ƒëƒÉng k√Ω gi√°m s√°t gi√°m h·ªô"`
                        });
                    }
                    
                    if (docs.hasGuardianAgreement === 'CHUA') {
                        appState.guidance.push({
                            type: 'warning',
                            message: `Ch·ªß s·ªü h·ªØu ${owner.name}: "C·∫ßn b·ªï sung VƒÉn b·∫£n ƒë·ªìng √Ω, KH√îNG ƒê∆Ø·ª¢C PH√âP CH·ª®NG TH·ª∞C CH·ªÆ K√ù - ho·∫∑c B·ªï sung CCCD ng∆∞·ªùi gi√°m s√°t l√™n k√Ω chung"`
                        });
                    } else if (docs.hasGuardianAgreement === 'CO') {
                        if (docs.agreementForm === 'CONG_CHUNG') {
                            appState.guidance.push({
                                type: 'info',
                                message: `Ch·ªß s·ªü h·ªØu ${owner.name}: "B·ªï sung CCCD Ng∆∞·ªùi gi√°m h·ªô; Ng∆∞·ªùi gi√°m h·ªô k√Ω thay cho ${owner.name} & ƒë√£ c√≥ vƒÉn b·∫£n ƒë·ªìng √Ω c·ªßa ng∆∞·ªùi gi√°m s√°t gi√°m h·ªô"`
                            });
                        } else if (docs.agreementForm === 'CHUNG_THUC_CHU_KY' || docs.agreementForm === 'CHUA_CHUNG') {
                            appState.guidance.push({
                                type: 'warning',
                                message: `Ch·ªß s·ªü h·ªØu ${owner.name}: "C·∫ßn b·ªï sung VƒÉn b·∫£n ƒë·ªìng √Ω ƒë∆∞·ª£c c√¥ng ch·ª©ng/ch·ª©ng th·ª±c n·ªôi dung - ho·∫∑c B·ªï sung CCCD ng∆∞·ªùi gi√°m h·ªô & CCCD c·ªßa ng∆∞·ªùi gi√°m s√°t gi√°m h·ªô k√Ω chung" & "(ng∆∞·ªùi gi√°m h·ªô k√Ω thay cho ${owner.name})"`
                            });
                        }
                    }
                });
            }
            
            // B.2.4 - X·ª≠ l√Ω gi√°m h·ªô cho v·ª£/ch·ªìng ch·ªß s·ªü h·ªØu (t∆∞∆°ng t·ª± B.2.2)
            if (civilCapacity.spousesLostCapacity.length > 0 && civilCapacity.transactionType !== 'TANG_CHO') {
                // Logic t∆∞∆°ng t·ª± B.2.2 nh∆∞ng cho v·ª£/ch·ªìng
                appState.guidance.push({
                    type: 'info',
                    message: '√Åp d·ª•ng h∆∞·ªõng d·∫´n t∆∞∆°ng t·ª± B.2.2 cho tr∆∞·ªùng h·ª£p v·ª£/ch·ªìng ch·ªß s·ªü h·ªØu b·ªã m·∫•t nƒÉng l·ª±c h√†nh vi'
                });
            }
            
            // B.2.5 - Tr∆∞·ªùng h·ª£p kh√¥ng c√≥ m·∫•t NLHV
            if (civilCapacity.ownersLostCapacity.length === 0 && civilCapacity.spousesLostCapacity.length === 0) {
                appState.guidance.push({
                    type: 'info',
                    message: 'B.2.5: "Ng∆∞·ªùi ƒë∆∞·ª£c x√°c ƒë·ªãnh theo H∆∞·ªõng d·∫´n n√†y s·∫Ω k√Ω vƒÉn b·∫£n"'
                });
            }
        }

        function analyzePowerOfAttorneyGuidance() {
            const poa = appState.answers.powerOfAttorney;
            
            // B.4.1 - 4.12: X·ª≠ l√Ω ·ªßy quy·ªÅn
            if (poa.owners.length === 0) {
                appState.guidance.push({
                    type: 'info',
                    message: 'B.4.1: "Ch√≠nh ch·ªß th·ªÉ tr·ª±c ti·∫øp k√Ω vƒÉn b·∫£n"'
                });
            } else {
                appState.guidance.push({
                    type: 'info',
                    message: 'B.4.2: "C·∫ßn xem x√©t n·ªôi dung ·ª¶y quy·ªÅn"'
                });
                
                if (poa.ownerInfo.hasTransactionContent === 'CHUA') {
                    appState.guidance.push({
                        type: 'warning',
                        message: 'B.4.3: "B·ªï sung l·∫°i UQ ho·∫∑c ch·ªß s·ªü h·ªØu_ƒë√£ ·ªßy quy·ªÅn tr·ª±c ti·∫øp k√Ω vƒÉn b·∫£n"'
                    });
                } else if (poa.ownerInfo.hasTransactionContent === 'CO') {
                    appState.guidance.push({
                        type: 'info',
                        message: 'B.4.4: "N·ªôi dung c√¥ng vi·ªác h·ª£p l·ªá"'
                    });
                }
                
                if (poa.ownerInfo.durationType === 'CHO_DEN_KHI_HOAN_THANH') {
                    appState.guidance.push({
                        type: 'info',
                        message: 'B.4.5: "Th·ªùi h·∫°n ·ª¶y quy·ªÅn h·ª£p l·ªá"'
                    });
                } else if (poa.ownerInfo.durationType === 'CHO_DEN_NGAY' || poa.ownerInfo.durationType === 'KHOANG_THOI_GIAN') {
                    appState.guidance.push({
                        type: 'warning',
                        message: 'B.4.6: "N·∫øu th·ªùi h·∫°n ƒë√£ h·∫øt th√¨ ch·ªß s·ªü h·ªØu ph·∫£i tr·ª±c ti·∫øp k√Ω vƒÉn b·∫£n"'
                    });
                }
                
                if (poa.ownerInfo.propertyScope === 'PHAN') {
                    appState.guidance.push({
                        type: 'info',
                        message: 'B.4.7: "Ph·∫£i ƒë·ªëi chi·∫øu v·ªõi ph·∫°m vi y√™u c·∫ßu giao d·ªãch"'
                    });
                } else if (poa.ownerInfo.propertyScope === 'TOAN_BO') {
                    appState.guidance.push({
                        type: 'info',
                        message: 'B.4.8: "Ph·∫°m vi t√†i s·∫£n ƒë∆∞·ª£c ·ªßy quy·ªÅn h·ª£p l·ªá"'
                    });
                }
                
                if (poa.ownerInfo.form === 'CHUNG_THUC_HOP_DONG') {
                    appState.guidance.push({
                        type: 'info',
                        message: 'B.4.9: "ki·ªÉm tra t√≠nh h·ª£p ph√°p c·ªßa vƒÉn b·∫£n ch·ª©ng th·ª±c"'
                    });
                } else if (poa.ownerInfo.form === 'CHUNG_THUC_CHU_KY') {
                    appState.guidance.push({
                        type: 'warning',
                        message: 'B.4.10: "VƒÉn b·∫£n ·ªßy quy·ªÅn kh√¥ng h·ª£p l·ªá, y√™u c·∫ßu ch·ªß s·ªü h·ªØu k√Ω"'
                    });
                } else if (poa.ownerInfo.form === 'CHUA_CHUNG') {
                    appState.guidance.push({
                        type: 'warning',
                        message: 'B.4.11: "y√™u c·∫ßu ch·ªß s·ªü h·ªØu k√Ω"'
                    });
                } else if (poa.ownerInfo.form === 'CONG_CHUNG') {
                    appState.guidance.push({
                        type: 'info',
                        message: 'B.4.12: "Ng∆∞·ªùi ƒë∆∞·ª£c ·ªßy quy·ªÅn s·∫Ω ƒë∆∞·ª£c ph√©p k√Ω thay cho ch·ªß s·ªü h·ªØu_ƒë√£ ·ªßy quy·ªÅn khi c√¥ng vi·ªác-th·ªùi h·∫°n- lo·∫°i t√†i s·∫£n- ph·∫°m vi t√†i s·∫£n h·ª£p l·ªá"'
                    });
                }
            }
            
            // X·ª≠ l√Ω t∆∞∆°ng t·ª± cho ·ªßy quy·ªÅn c·ªßa v·ª£/ch·ªìng
            if (poa.spouses.length > 0) {
                appState.guidance.push({
                    type: 'info',
                    message: '√Åp d·ª•ng h∆∞·ªõng d·∫´n t∆∞∆°ng t·ª± B.4.1-4.12 cho tr∆∞·ªùng h·ª£p ·ªßy quy·ªÅn c·ªßa v·ª£/ch·ªìng ch·ªß s·ªü h·ªØu'
                });
            }
        }

        function calculateAge(birthDate) {
            if (!birthDate) return 0;
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function formatDate(date) {
            if (!date) return '';
            return date.toLocaleDateString('vi-VN');
        }

        function displayGuidance() {
            const questionPhase = document.getElementById('question-phase');
            const guidancePhase = document.getElementById('guidance-phase');
            const resultsDiv = document.getElementById('guidance-results');
            
            questionPhase.style.display = 'none';
            guidancePhase.style.display = 'block';
            
            resultsDiv.innerHTML = '';
            
            if (appState.guidance.length === 0) {
                resultsDiv.innerHTML = '<div class="guidance-item info">Kh√¥ng c√≥ h∆∞·ªõng d·∫´n c·ª• th·ªÉ. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin ƒë√£ nh·∫≠p.</div>';
                return;
            }
            
            appState.guidance.forEach(item => {
                const div = document.createElement('div');
                div.className = `guidance-item ${item.type}`;
                div.innerHTML = item.message;
                resultsDiv.appendChild(div);
            });
            
            // C·∫≠p nh·∫≠t step indicator
            document.getElementById('step-B').classList.add('active');
        }

        function showQuestionPhase() {
            document.getElementById('question-phase').style.display = 'block';
            document.getElementById('guidance-phase').style.display = 'none';
            showSection('A1');
        }

        function resetApp() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m l·∫°i t·ª´ ƒë·∫ßu? To√†n b·ªô th√¥ng tin ƒë√£ nh·∫≠p s·∫Ω b·ªã m·∫•t.')) {
                location.reload();
            }
        }

        // ===============================
        // INITIALIZATION
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
        });
    </script>
</body>
</html>